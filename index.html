<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wind Turbine Digital Twin â€“ AR + MQTT</title>

<!-- Model Viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<!-- MQTT -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- Sound -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#0b1220;
  font-family:system-ui,sans-serif;
  overflow:hidden;
}

/* MODEL */
model-viewer{
  width:100vw;
  height:100vh;
}

/* ===== OVERLAY ROOT (REQUIRED FOR AR) ===== */
#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.panel,
.ar-btn {
  pointer-events: auto;
}


/* ===== PANEL ===== */
.panel{
  position:absolute;
  top:10px;
  left:10px;
  width:min(92vw,260px);
  max-height:85vh;
  background:linear-gradient(180deg,#020617,#020617);
  border-radius:14px;
  padding:12px;
  color:#e5e7eb;
  box-shadow:0 15px 35px rgba(0,0,0,0.6);
  overflow:auto;
  pointer-events:auto;
}

.panel h3{
  margin:0 0 8px;
  font-size:14px;
  color:#38bdf8;
}

.stat{
  display:flex;
  justify-content:space-between;
  margin:5px 0;
  font-size:12px;
}

.label{color:#94a3b8;}
.value{font-weight:600;color:#22d3ee;}
.value.on{color:#4ade80;}
.value.off{color:#f87171;}

canvas{
  margin-top:8px;
}

/* ===== AR BUTTON ===== */
.ar-btn{
  position:absolute;
  bottom:16px;
  right:16px;
  padding:14px 18px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,#2563eb,#38bdf8);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  pointer-events:auto;
  box-shadow:0 15px 35px rgba(0,0,0,0.6);
}
</style>
</head>

<body>

<model-viewer
  id="model"
  src="Model/windmill.glb"
  camera-controls
  exposure="1.1"
  shadow-intensity="1.2"
  environment-image="neutral"

  ar
  ar-modes="webxr"
  ar-scale="auto"
  ar-placement="floor"

  webxr="optionalFeatures: dom-overlay"
  ar-dom-overlay
  ar-dom-overlay-root="#overlay"

  animation-loop="false">
</model-viewer>


<!-- OVERLAY -->
<div id="overlay">

  <div class="panel">
    <h3>ðŸŒ¬ Wind Turbine SCADA</h3>

    <div class="stat"><span class="label">Status</span>
      <span id="status" class="value off">OFF</span>
    </div>

    <div class="stat"><span class="label">Wind Speed</span>
      <span id="wind" class="value">0.0 m/s</span>
    </div>

    <div class="stat"><span class="label">Rotor Load</span>
      <span id="load" class="value">0 %</span>
    </div>

    <div class="stat"><span class="label">Power Output</span>
      <span id="power" class="value">0 kW</span>
    </div>

    <canvas id="chart" height="100"></canvas>
  </div>

  <button class="ar-btn" id="arBtn">View in AR</button>
</div>

<script>
/* ================= CONSTANTS ================= */
const ADC_MAX = 4095;
const MAX_WIND = 25;
const RATED_POWER = 3000;
const SMOOTHING = 0.08;

/* ================= MODEL ================= */
const viewer = document.getElementById("model");

/* ================= SOUND ================= */
const sound = new Howl({
  src:["sound/windmill.mp3"],
  loop:true,
  volume:0.6
});
window.addEventListener("click",()=>{try{sound.play();sound.pause();}catch{}});

/* ================= GRAPH ================= */
const chart = new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[{
    data:[],
    borderColor:"#38bdf8",
    borderWidth:2,
    tension:0.35,
    pointRadius:0
  }]},
  options:{
    animation:false,
    plugins:{legend:{display:false}},
    scales:{x:{display:false},y:{min:0,max:RATED_POWER}}
  }
});

/* ================= MQTT ================= */
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

/* ================= STATE ================= */
let currentAnimSpeed = 0;
let spinning = false;

/* ================= HELPERS ================= */
const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);

function stopSystem(){
  viewer.pause();
  sound.stop();
  currentAnimSpeed = 0;
  spinning = false;
}

/* ================= MQTT HANDLER ================= */
client.on("connect",()=>client.subscribe("Equanimous/AR/sensor"));
client.on("offline",stopSystem);
client.on("close",stopSystem);

client.on("message",(_,msg)=>{
  try{
    const d = JSON.parse(msg.toString());
    const sw = Number(d.Switch1)||0;
    const pot = Number(d.Pot1)||0;

    const norm = clamp(pot / ADC_MAX,0,1);
    const wind = norm * MAX_WIND;
    const power = RATED_POWER * Math.pow(norm,3);
    const load = (power / RATED_POWER) * 100;

    // UI
    const statusEl=document.getElementById("status");
    statusEl.textContent=sw?"ON":"OFF";
    statusEl.className="value "+(sw?"on":"off");

    document.getElementById("wind").textContent=wind.toFixed(2)+" m/s";
    document.getElementById("load").textContent=load.toFixed(1)+" %";
    document.getElementById("power").textContent=power.toFixed(0)+" kW";

    chart.data.labels.push("");
    chart.data.datasets[0].data.push(power);
    if(chart.data.labels.length>30){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();

    if(!sw || norm === 0){
      stopSystem();
      return;
    }

    const targetSpeed = 0.15 + norm * 2.5;
    currentAnimSpeed += (targetSpeed - currentAnimSpeed) * SMOOTHING;

    if(!spinning){
      viewer.animationName="Animation";
      viewer.play();
      spinning=true;
    }
    viewer.animationSpeed = currentAnimSpeed;

    sound.rate(0.6 + norm * 1.6);
    if(!sound.playing()) sound.play();

  }catch(e){}
});

/* ================= AR ================= */
document.getElementById("arBtn").onclick=async()=>{
  if(viewer.canActivateAR) await viewer.activateAR();
  else alert("WebXR not supported (use Chrome)");
};
</script>

</body>
</html>
