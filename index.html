<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Windmill WebXR AR + MQTT</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

  <!-- MQTT -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Sound -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

  <!-- A-Frame Gesture Detector (for future use) -->
  <script src="https://unpkg.com/aframe-gesture-detector/dist/aframe-gesture-detector.min.js"></script>
</head>

<body style="margin:0; background:black;">

<!-- âœ… WEBXR ENABLED SCENE -->
<a-scene
  renderer="colorManagement: true"
  xr-mode-ui="enabled: true"
  webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: body">

  <!-- CAMERA -->
  <a-camera position="0 1.6 0"></a-camera>

  <!-- ASSETS -->
  <a-assets>
    <a-asset-item id="windmill" src="Model/windmill.glb"></a-asset-item>
  </a-assets>

  <!-- MODEL -->
  <a-entity
  id="model"
  gltf-model="#windmill"
  position="0 -0.7 -4"
  rotation="0 0 0"
  scale="3 3 3"

  animation-mixer="clip: Animation; timeScale: 0; loop: repeat"

  gesture-detector
  gesture-handler="
    translate: true;
    rotate: false;
    scale: true;
    minScale: 0.5;
    maxScale: 6;
  ">
</a-entity>


  <!-- UI TEXTS -->
  <a-text id="statusText" value="OFF" position="-1.2 1.1 -3" scale="0.7 0.7 0.7" color="yellow"></a-text>
  <a-text id="speedText"  value="0 %" position="0.9 1.1 -3"  scale="0.7 0.7 0.7" color="yellow"></a-text>
  <a-text id="loadText"   value="0 %" position="-1.3 0.2 -3" scale="0.7 0.7 0.7" color="yellow"></a-text>
  <a-text id="powerText"  value="0 kW" position="0.8 0.2 -3"   scale="0.7 0.7 0.7" color="yellow"></a-text>

  <a-text value="STATUS"       position="-1.3 0.7 -3" scale="0.7 0.7 0.7" color="yellow"></a-text>
  <a-text value="WIND SPEED"   position="0.6 0.7 -3"   scale="0.7 0.7 0.7" color="yellow"></a-text>
  <a-text value="LOAD"         position="-1.3 -0.2 -3" scale="0.7 0.7 0.7" color="yellow"></a-text>
  <a-text value="OUTPUT POWER" position="0.5 -0.2 -3" scale="0.7 0.7 0.7" color="yellow"></a-text>

</a-scene>

<script>
/* ======================
   CONSTANTS
====================== */
const topic = "Equanimous/AR/sensor";
const clipName = "Animation";
const MAX_POWER = 5;
const POT_THRESHOLD = 0.02;

/* ======================
   SOUND
====================== */
const sound = new Howl({
  src: ["sound/windmill.mp3"],
  loop: true,
  volume: 0.5
});

// unlock mobile audio
window.addEventListener("click", () => {
  try { sound.play(); sound.pause(); } catch {}
});

/* ======================
   MQTT
====================== */
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

client.on("connect", () => {
  client.subscribe(topic);
});

client.on("message", (_, msg) => {
  try {
    handleIncoming(JSON.parse(msg.toString()));
  } catch {
    console.warn("Invalid MQTT payload");
  }
});

/* ======================
   HELPERS
====================== */
function normalizeSpeed(pot) {
  return Math.max(0, Math.min(1, pot / 4095));
}

function soundRateFromSpeed(speed) {
  return 0.5 + speed * 1.5;
}

/* ======================
   MAIN LOGIC
====================== */
function handleIncoming(obj) {
  const switchValue = Number(obj.Switch1) || 0;
  const potValue = Number(obj.Pot1) || 0;
  const speed = normalizeSpeed(potValue);

  const model = document.getElementById("model");

  document.getElementById("statusText")
    .setAttribute("value", switchValue ? "ON" : "OFF");

  if (!switchValue) {
    model.setAttribute("animation-mixer", `clip:${clipName}; timeScale:0`);
    sound.stop();
    updateValues(0);
    return;
  }

  model.setAttribute(
    "animation-mixer",
    `clip:${clipName}; timeScale:${speed * 2}; loop:repeat`
  );

  if (speed > POT_THRESHOLD) {
    sound.rate(soundRateFromSpeed(speed));
    if (!sound.playing()) sound.play();
  } else {
    sound.stop();
  }

  updateValues(speed);
}

/* ======================
   UI UPDATE
====================== */
function updateValues(speed) {
  document.getElementById("speedText")
    .setAttribute("value", Math.round(speed * 100) + " %");

  document.getElementById("loadText")
    .setAttribute("value", (speed * 100).toFixed(1) + " %");

  document.getElementById("powerText")
    .setAttribute("value", (speed * speed * MAX_POWER).toFixed(2) + " kW");
}
</script>

</body>
</html>
